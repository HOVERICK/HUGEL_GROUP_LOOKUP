<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>휴젤 워크숍 · 조 검색</title>
<style>
:root { --maxw: 860px; }
* { box-sizing: border-box; }
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,"Apple SD Gothic Neo","맑은 고딕",sans-serif; margin:0; background:#f7f7fb; color:#111; }
.header { max-width: var(--maxw); margin:24px auto 0; padding:0 16px; }
.h1 { font-size:20px; font-weight:700; margin:8px 0 4px; }
.sub { color:#666; font-size:14px; margin-bottom:12px; }
.card { max-width:var(--maxw); background:#fff; margin:12px auto; border-radius:16px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
.row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
input[type="text"] { flex:1; min-width:240px; padding:12px 14px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
button { padding:12px 14px; border:none; border-radius:12px; background:#111; color:#fff; font-weight:700; cursor:pointer; }
.table-wrap { overflow:auto; border:1px solid #eee; border-radius:12px; }
table { width:100%; border-collapse:collapse; min-width:680px; }
th, td { padding:10px 12px; border-bottom:1px solid #f0f0f0; text-align:left; font-size:14px; }
th { background:#fafafa; position:sticky; top:0; z-index:1; }
tr:hover td { background:#fcfcff; }
.count { font-size:12px; color:#666; margin:10px 0 0; }
.footer { max-width:var(--maxw); margin:8px auto 24px; padding:0 16px; color:#888; font-size:12px; }
.badge { display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; background:#eef; color:#225; margin-left:6px; }
.err { color:#c00; font-size:12px; margin-top:6px; white-space:pre-line; }
</style>
</head>
<body>
  <div class="header">
    <div class="h1">휴젤 워크숍 · 조 검색 <span class="badge">Yamoiza</span></div>
    <div class="sub">이름을 입력하면 이름 / 부서 / 소속 / <b>오전조(알파벳,숫자)</b> / <b>오후조(알파벳)</b>를 확인할 수 있습니다.</div>
  </div>

  <div class="card">
    <div class="row">
      <input id="q" type="text" placeholder="이름 입력 (예: 홍길동)" />
      <button id="btn" onclick="run()">검색</button>
    </div>
    <div id="err" class="err"></div>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>이름</th><th>부서</th><th>소속</th><th>오전조</th><th>오후조</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="count" id="count"></div>
  </div>

  <div class="footer">© <span id="today"></span> Yamoiza · GitHub Pages</div>

  <!-- SheetJS (브라우저에서 엑셀 파싱) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.getElementById('today').textContent = new Date().toISOString().slice(0,10);

// ✅ 엑셀 경로: 레포 안의 위치/파일명이 다르면 아래만 바꿔주세요.
const XLSX_URL = "./data/group_records.xlsx?v=" + Date.now();

const rowsEl = document.getElementById('rows');
const countEl = document.getElementById('count');
const qEl = document.getElementById('q');
const errEl = document.getElementById('err');
const COLUMNS = ["이름","부서","소속","오전조","오후조"];

function norm(s){ return (s||"").toString().trim().replace(/\s+/g,"").toLowerCase(); }

// =========== 마커/행 인식을 더 견고하게 ===========
function isDigits(s){ return /^[0-9]+$/.test(s); }
function cleanToken(s){ return String(s||"").replace(/\s+/g,"").trim(); }

// 마커 셀 판정(M2, A10, 한글+숫자도 허용). 공백 섞여있어도 OK.
function isMarkerToken(tok){ return /^[A-Za-z가-힣]+[0-9]+$/.test(cleanToken(tok)); }

// "마커 행" 판정: (1) 전체 셀 중 마커 토큰이 1개이고, (2) 나머지 셀은 전부 비었거나 매우 사소한 값
function getMarkerFromRow(cells){
  const trimmed = (cells||[]).map(x => cleanToken(x));
  const candidates = trimmed.filter(x => x && isMarkerToken(x));
  const nonEmpty = trimmed.filter(x => x).length;
  if (candidates.length === 1 && nonEmpty <= 2) return candidates[0]; // ex) [ "", "M2", "" ] or "M 2"
  return "";
}

// 구성원 행 판정: 보통 (번호/소속/이름/부서)로 3칸 이상 채워짐, 또는 첫 칸이 숫자면서 2칸 이상
function looksLikeMemberRow(cells){
  const trimmed = (cells||[]).map(x => String(x).trim());
  const filled = trimmed.filter(v => v!=="").length;
  const firstIsNum = isDigits(trimmed[0]);
  return (filled >= 3) || (firstIsNum && filled >= 2);
}

function pickName(cells){
  // 이름은 보통 2~4번째 셀; 팀/본부/센터 같은 부서 키워드는 제외
  for (const idx of [2,1,3,0,4]){
    const v = String(cells[idx] ?? "").trim();
    if(/[가-힣]{2,4}/.test(v) && !/팀|본부|센터|\)/.test(v)) return v;
  }
  for (let i=0;i<cells.length;i++){
    const v = String(cells[i] ?? "").trim();
    if(/[가-힣]{2,4}/.test(v)) return v;
  }
  return "";
}
function pickDept(cells){
  for (const idx of [3,2,4,1,0]){
    const v = String(cells[idx] ?? "").trim();
    if(/팀|본부|센터|\)/.test(v)) return v;
  }
  return "";
}
function pickOrg(cells){
  for (const idx of [1,2,3,0,4]){
    const v = String(cells[idx] ?? "").trim();
    if(v) return v;
  }
  return "";
}
function afternoonFromMarker(marker){
  return cleanToken(marker).replace(/[0-9]/g,""); // 'M2' → 'M'
}

// =========== 엑셀 로드 & 파싱 ===========
async function loadXLSX(){
  const resp = await fetch(XLSX_URL, {cache:"no-store"});
  if(!resp.ok) throw new Error("엑셀 불러오기 실패: " + resp.status + " " + resp.statusText);
  const buf  = await resp.arrayBuffer();
  const wb   = XLSX.read(buf, {type:'array'});

  const members = [];
  for(const sheetName of wb.SheetNames){
    const ws   = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    if(!rows.length) continue;

    let marker = "";
    for(let r=0; r<rows.length; r++){
      const row = rows[r] || [];

      // 1) 마커 감지 (여러 셀 중 하나라도 'M2'형이면 마커로 채택)
      const found = getMarkerFromRow(row);
      if(found){
        marker = found; // ex) 'M2'
        continue;
      }

      // 2) 구성원 행
